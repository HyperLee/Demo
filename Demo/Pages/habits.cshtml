@page "/habits"
@model Demo.Pages.HabitsModel
@{
    ViewData["Title"] = "ç¿’æ…£è¿½è¹¤å™¨";
}

@section Styles {
    <link rel="stylesheet" href="~/css/habits.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
}

<div class="container-fluid">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">
            <i class="fas fa-calendar-check text-primary"></i>
            ç¿’æ…£è¿½è¹¤å™¨
        </h1>
        <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#addHabitModal">
            <i class="fas fa-plus"></i> æ–°å¢ç¿’æ…£
        </button>
    </div>

    <!-- æˆåŠŸ/éŒ¯èª¤è¨Šæ¯ -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- çµ±è¨ˆå„€è¡¨æ¿ -->
    <div class="habit-dashboard mb-4">
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-check-circle text-success me-2" style="font-size: 1.5rem;"></i>
                            <h5 class="card-title mb-0">ä»Šæ—¥å®Œæˆ</h5>
                        </div>
                        <h2 class="text-success mb-0">@Model.PageData.TodayCompleted/@Model.PageData.TotalHabits</h2>
                        <small class="text-muted">å€‹ç¿’æ…£</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-chart-line text-primary me-2" style="font-size: 1.5rem;"></i>
                            <h5 class="card-title mb-0">æœ¬é€±æˆåŠŸç‡</h5>
                        </div>
                        <h2 class="text-primary mb-0">@Model.PageData.WeeklySuccessRate.ToString("F1")%</h2>
                        <small class="text-muted">å®Œæˆåº¦</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-fire text-warning me-2" style="font-size: 1.5rem;"></i>
                            <h5 class="card-title mb-0">æœ€é•·é€£çºŒ</h5>
                        </div>
                        <h2 class="text-warning mb-0">@Model.PageData.LongestStreak</h2>
                        <small class="text-muted">å¤©</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-list text-info me-2" style="font-size: 1.5rem;"></i>
                            <h5 class="card-title mb-0">ç¸½ç¿’æ…£æ•¸</h5>
                        </div>
                        <h2 class="text-info mb-0">@Model.PageData.TotalHabits</h2>
                        <small class="text-muted">å€‹ç¿’æ…£</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€±é€²åº¦åœ–è¡¨ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-area text-primary"></i>
                é€±é€²åº¦è¶¨å‹¢
            </h5>
        </div>
        <div class="card-body">
            <canvas id="weeklyProgressChart" height="100"></canvas>
        </div>
    </div>

    <!-- ç¿’æ…£åˆ†é¡ç¯©é¸ -->
    <div class="habit-categories mb-4">
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-outline-primary active category-filter-btn" data-category="all">
                <i class="fas fa-th-large"></i>
                å…¨éƒ¨ (@Model.PageData.TotalHabits)
            </button>
            @foreach (var category in Model.PageData.Categories)
            {
                var habitCount = Model.PageData.TodayHabits.Count(h => h.Category.Id == category.Id);
                <button type="button" class="btn btn-outline-primary category-filter-btn" data-category="@category.Id">
                    <i class="@category.IconClass"></i>
                    @category.Name (@habitCount)
                </button>
            }
        </div>
    </div>

    <!-- ä»Šæ—¥ç¿’æ…£æ¸…å–® -->
    <div class="today-habits">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>
                <i class="fas fa-calendar-day text-primary"></i> 
                ä»Šæ—¥ç¿’æ…£ <small class="text-muted">(@DateTime.Today.ToString("yyyy/MM/dd"))</small>
            </h3>
        </div>
        
        @if (Model.PageData.TodayHabits.Any())
        {
            <div class="habit-grid" id="habitGrid">
                @foreach (var habit in Model.PageData.TodayHabits)
                {
                    <partial name="_HabitCard" model="habit" />
                }
            </div>
        }
        else
        {
            <div class="empty-state text-center py-5">
                <i class="fas fa-plus-circle text-muted" style="font-size: 4rem;"></i>
                <h4 class="text-muted mt-3">é‚„æ²’æœ‰ä»»ä½•ç¿’æ…£</h4>
                <p class="text-muted">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢ç¿’æ…£ã€æŒ‰éˆ•é–‹å§‹å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹ç¿’æ…£ï¼</p>
                <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addHabitModal">
                    <i class="fas fa-plus"></i> æ–°å¢ç¬¬ä¸€å€‹ç¿’æ…£
                </button>
            </div>
        }
    </div>
</div>

<!-- æ–°å¢ç¿’æ…£ Modal -->
<div class="modal fade" id="addHabitModal" tabindex="-1" aria-labelledby="addHabitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addHabitModalLabel">
                    <i class="fas fa-plus-circle"></i>
                    æ–°å¢ç¿’æ…£
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="CreateHabit">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label asp-for="NewHabit.Name" class="form-label">ç¿’æ…£åç¨± <span class="text-danger">*</span></label>
                            <input asp-for="NewHabit.Name" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ¯å¤©å–8æ¯æ°´" maxlength="100" required>
                            <span asp-validation-for="NewHabit.Name" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="NewHabit.CategoryId" class="form-label">åˆ†é¡ <span class="text-danger">*</span></label>
                            <select asp-for="NewHabit.CategoryId" class="form-select" required>
                                <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                                @foreach (var category in Model.PageData.Categories)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </select>
                            <span asp-validation-for="NewHabit.CategoryId" class="text-danger"></span>
                        </div>
                        <div class="col-12">
                            <label asp-for="NewHabit.Description" class="form-label">æè¿°</label>
                            <textarea asp-for="NewHabit.Description" class="form-control" rows="2" placeholder="ç°¡å–®æè¿°é€™å€‹ç¿’æ…£çš„ç›®æ¨™å’Œå¥½è™•" maxlength="500"></textarea>
                            <span asp-validation-for="NewHabit.Description" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="NewHabit.IconClass" class="form-label">åœ–æ¨™</label>
                            <select asp-for="NewHabit.IconClass" class="form-select">
                                <option value="fas fa-star">â­ æ˜Ÿæ˜Ÿ</option>
                                <option value="fas fa-heart">â¤ï¸ æ„›å¿ƒ</option>
                                <option value="fas fa-dumbbell">ğŸ‹ï¸ å•éˆ´</option>
                                <option value="fas fa-book">ğŸ“š æ›¸æœ¬</option>
                                <option value="fas fa-coffee">â˜• å’–å•¡</option>
                                <option value="fas fa-running">ğŸƒ è·‘æ­¥</option>
                                <option value="fas fa-bed">ğŸ›ï¸ åºŠ</option>
                                <option value="fas fa-apple-alt">ğŸ è˜‹æœ</option>
                                <option value="fas fa-guitar">ğŸ¸ å‰ä»–</option>
                                <option value="fas fa-paint-brush">ğŸ¨ ç•«ç­†</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="NewHabit.Color" class="form-label">é¡è‰²</label>
                            <input asp-for="NewHabit.Color" type="color" class="form-control form-control-color" value="#007bff">
                        </div>
                        <div class="col-md-4">
                            <label asp-for="NewHabit.TargetCount" class="form-label">æ¯æ—¥ç›®æ¨™æ¬¡æ•¸</label>
                            <input asp-for="NewHabit.TargetCount" type="number" class="form-control" min="1" max="10" value="1">
                            <span asp-validation-for="NewHabit.TargetCount" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="NewHabit.Frequency" class="form-label">é »ç‡</label>
                            <select asp-for="NewHabit.Frequency" class="form-select">
                                <option value="1">æ¯æ—¥</option>
                                <option value="2">æ¯é€±</option>
                                <option value="3">æ¯æœˆ</option>
                                <option value="4">è‡ªè¨‚</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="NewHabit.TargetEndDate" class="form-label">ç›®æ¨™çµæŸæ—¥æœŸ</label>
                            <input asp-for="NewHabit.TargetEndDate" type="date" class="form-control" min="@DateTime.Today.ToString("yyyy-MM-dd")">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> æ–°å¢ç¿’æ…£
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç¿’æ…£è©³æƒ… Modal -->
<div class="modal fade" id="habitDetailModal" tabindex="-1" aria-labelledby="habitDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="habitDetailModalLabel">
                    <i class="fas fa-chart-line"></i>
                    ç¿’æ…£è©³æƒ…
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="habitDetailContent">
                    <!-- å‹•æ…‹è¼‰å…¥å…§å®¹ -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/habits.js"></script>
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        // åˆå§‹åŒ–é é¢
        $(document).ready(function() {
            // è¼‰å…¥é€±é€²åº¦åœ–è¡¨
            loadWeeklyProgressChart();
            
            // ç¶å®šåˆ†é¡ç¯©é¸äº‹ä»¶
            $('.category-filter-btn').on('click', function() {
                var category = $(this).data('category');
                filterHabitsByCategory(category);
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                $('.category-filter-btn').removeClass('active');
                $(this).addClass('active');
            });
        });

        // è¼‰å…¥é€±é€²åº¦åœ–è¡¨
        async function loadWeeklyProgressChart() {
            try {
                const response = await fetch('/habits?handler=WeeklyProgress');
                const result = await response.json();
                
                if (result.success) {
                    const ctx = document.getElementById('weeklyProgressChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: result.data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return 'å®Œæˆç‡: ' + context.parsed.y + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.error('è¼‰å…¥é€±é€²åº¦è³‡æ–™å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('è¼‰å…¥é€±é€²åº¦åœ–è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // æ ¹æ“šåˆ†é¡ç¯©é¸ç¿’æ…£
        function filterHabitsByCategory(categoryId) {
            const habitCards = document.querySelectorAll('.habit-card');
            
            habitCards.forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                
                if (categoryId === 'all' || cardCategory === categoryId) {
                    card.style.display = 'block';
                    // æ·»åŠ æ·¡å…¥æ•ˆæœ
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.style.opacity = '1';
                    }, 50);
                } else {
                    card.style.display = 'none';
                }
            });
        }
    </script>
}
