<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能分類系統測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/smart-category.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-magic text-primary"></i>
            智能分類系統測試
        </h1>

        <!-- 測試區域 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-edit"></i> 輸入測試資料</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="testDescription" class="form-label">交易描述</label>
                            <input type="text" id="testDescription" class="form-control" 
                                   placeholder="例如: 星巴克咖啡、午餐、加油">
                        </div>
                        <div class="mb-3">
                            <label for="testAmount" class="form-label">金額</label>
                            <input type="number" id="testAmount" class="form-control" 
                                   placeholder="例如: 150">
                        </div>
                        <div class="mb-3">
                            <label for="testMerchant" class="form-label">商家</label>
                            <input type="text" id="testMerchant" class="form-control" 
                                   placeholder="例如: 7-11、麥當勞">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="testSmartCategory()">
                            <i class="fas fa-magic"></i> 測試智能分類
                        </button>
                    </div>
                </div>

                <!-- 測試按鈕組 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-vials"></i> 快速測試</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="quickTest('早餐', 80, '麥當勞')">
                                測試餐飲 - 麥當勞早餐
                            </button>
                            <button class="btn btn-outline-success" onclick="quickTest('捷運', 20, '台北捷運')">
                                測試交通 - 捷運
                            </button>
                            <button class="btn btn-outline-warning" onclick="quickTest('買藥', 120, '屈臣氏')">
                                測試醫療 - 買藥
                            </button>
                            <button class="btn btn-outline-info" onclick="quickTest('看電影', 280, '威秀影城')">
                                測試娛樂 - 電影
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <!-- 智能分類建議區域 -->
                <div class="smart-category-section" id="smartCategorySection" style="display: none;">
                    <label class="form-label">
                        <i class="fas fa-magic text-primary"></i> 智能分類建議
                    </label>
                    <div id="categorySuggestions" class="category-suggestions">
                        <!-- 動態載入分類建議 -->
                    </div>
                </div>

                <!-- 系統統計 -->
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-bar"></i> 系統統計</h6>
                    </div>
                    <div class="card-body" id="statisticsArea">
                        <p class="text-muted">點擊「載入統計」按鈕查看系統統計資訊</p>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadStatistics()">
                            <i class="fas fa-refresh"></i> 載入統計
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 測試日誌 -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-list"></i> 測試日誌</h6>
            </div>
            <div class="card-body">
                <div id="testLog" style="max-height: 300px; overflow-y: auto;">
                    <p class="text-muted">測試日誌將顯示在這裡...</p>
                </div>
                <button class="btn btn-outline-warning btn-sm" onclick="clearLog()">
                    <i class="fas fa-trash"></i> 清除日誌
                </button>
            </div>
        </div>
    </div>

    <!-- 分類建議卡片樣板 -->
    <script type="text/template" id="suggestionCardTemplate">
        <div class="suggestion-card" data-category-id="{{categoryId}}" data-confidence="{{confidence}}">
            <div class="suggestion-content">
                <div class="suggestion-icon">
                    <i class="{{iconClass}}"></i>
                </div>
                <div class="suggestion-info">
                    <div class="suggestion-name">{{categoryName}}</div>
                    <div class="suggestion-reason">{{reason}}</div>
                </div>
                <div class="suggestion-confidence">
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: {{confidencePercent}}%"></div>
                    </div>
                    <small>{{confidencePercent}}%</small>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-success" onclick="provideFeedback('{{categoryId}}', true)">
                <i class="fas fa-thumbs-up"></i>
            </button>
        </div>
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 測試智能分類
        async function testSmartCategory() {
            const description = document.getElementById('testDescription').value;
            const amount = parseFloat(document.getElementById('testAmount').value) || 0;
            const merchant = document.getElementById('testMerchant').value;

            if (!description && !merchant) {
                alert('請至少填入描述或商家');
                return;
            }

            logMessage(`測試輸入: 描述="${description}", 金額=${amount}, 商家="${merchant}"`);
            showLoadingState();

            try {
                const response = await fetch('/api/smart-category/suggest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: description,
                        amount: amount,
                        merchant: merchant,
                        maxSuggestions: 5
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    logMessage(`收到 ${data.suggestions?.length || 0} 個建議`);
                    displaySuggestions(data.suggestions || []);
                } else {
                    logMessage(`請求失敗: ${response.status}`, 'error');
                    hideLoadingState();
                }
            } catch (error) {
                logMessage(`請求錯誤: ${error.message}`, 'error');
                hideLoadingState();
            }
        }

        // 快速測試
        function quickTest(description, amount, merchant) {
            document.getElementById('testDescription').value = description;
            document.getElementById('testAmount').value = amount;
            document.getElementById('testMerchant').value = merchant;
            testSmartCategory();
        }

        // 顯示建議
        function displaySuggestions(suggestions) {
            const container = document.getElementById('categorySuggestions');
            const template = document.getElementById('suggestionCardTemplate').innerHTML;
            
            container.innerHTML = '';
            
            if (suggestions.length === 0) {
                container.innerHTML = `
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-search"></i> 找不到合適的分類建議
                    </div>
                `;
            } else {
                suggestions.forEach(suggestion => {
                    const confidencePercent = Math.round(suggestion.confidence * 100);
                    let card = template;
                    
                    card = card.replace(/\{\{categoryId\}\}/g, suggestion.categoryId);
                    card = card.replace(/\{\{categoryName\}\}/g, suggestion.categoryName);
                    card = card.replace(/\{\{iconClass\}\}/g, suggestion.iconClass || 'fas fa-tag');
                    card = card.replace(/\{\{reason\}\}/g, suggestion.reason);
                    card = card.replace(/\{\{confidence\}\}/g, suggestion.confidence);
                    card = card.replace(/\{\{confidencePercent\}\}/g, confidencePercent);
                    
                    container.innerHTML += card;
                });
            }
            
            document.getElementById('smartCategorySection').style.display = 'block';
        }

        // 提供回饋
        async function provideFeedback(categoryId, isCorrect) {
            const description = document.getElementById('testDescription').value;
            const amount = parseFloat(document.getElementById('testAmount').value) || 0;
            const merchant = document.getElementById('testMerchant').value;

            try {
                const response = await fetch('/api/smart-category/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        categoryId: categoryId,
                        description: description,
                        amount: amount,
                        merchant: merchant,
                        isCorrect: isCorrect
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    logMessage(`回饋已提交: ${isCorrect ? '正確' : '錯誤'}`);
                } else {
                    logMessage(`回饋提交失敗: ${response.status}`, 'error');
                }
            } catch (error) {
                logMessage(`回饋提交錯誤: ${error.message}`, 'error');
            }
        }

        // 載入統計
        async function loadStatistics() {
            try {
                const response = await fetch('/api/smart-category/statistics');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayStatistics(data.statistics);
                    } else {
                        logMessage(`載入統計失敗: ${data.error}`, 'error');
                    }
                } else {
                    logMessage(`載入統計請求失敗: ${response.status}`, 'error');
                }
            } catch (error) {
                logMessage(`載入統計錯誤: ${error.message}`, 'error');
            }
        }

        // 顯示統計
        function displayStatistics(stats) {
            const area = document.getElementById('statisticsArea');
            area.innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-primary">${stats.TotalRecords}</h4>
                            <small>總記錄數</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-success">${stats.CorrectPredictions}</h4>
                            <small>正確預測</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>分類分佈:</h6>
                    ${Object.entries(stats.CategoryBreakdown).map(([key, value]) => 
                        `<span class="badge bg-secondary me-1">${key}: ${value}</span>`
                    ).join('')}
                </div>
            `;
        }

        // 顯示載入狀態
        function showLoadingState() {
            document.getElementById('categorySuggestions').innerHTML = `
                <div class="smart-category-loading">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    正在分析中...
                </div>
            `;
            document.getElementById('smartCategorySection').style.display = 'block';
        }

        // 隱藏載入狀態
        function hideLoadingState() {
            document.getElementById('smartCategorySection').style.display = 'none';
        }

        // 記錄日誌
        function logMessage(message, type = 'info') {
            const logArea = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const iconClass = type === 'error' ? 'fas fa-exclamation-triangle text-danger' : 'fas fa-info-circle text-info';
            
            const logEntry = `
                <div class="mb-1">
                    <small class="text-muted">[${timestamp}]</small>
                    <i class="${iconClass}"></i>
                    ${message}
                </div>
            `;
            
            logArea.innerHTML = logEntry + logArea.innerHTML;
        }

        // 清除日誌
        function clearLog() {
            document.getElementById('testLog').innerHTML = '<p class="text-muted">測試日誌將顯示在這裡...</p>';
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('智能分類測試頁面已載入');
            loadStatistics();
        });
    </script>
</body>
</html>
